<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - CEASA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SDK do Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-green-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-green-700 text-white shadow-md">
    <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
      <h1 class="text-2xl font-bold">üå± CEASA - Dashboard</h1>
      <a href="/login.html" class="bg-white text-green-700 px-4 py-2 rounded-lg font-semibold hover:bg-green-100">Sair</a>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow max-w-6xl mx-auto mt-8 p-6 bg-white shadow-lg rounded-2xl">
    <h2 class="text-xl font-semibold text-green-700 mb-6">Bem-vindo ao Sistema CEASA</h2>

    <p class="mb-4 text-gray-700">
      Aqui voc√™ pode gerenciar empresas e acessar arquivos disponibilizados pelo administrador.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="p-4 border rounded-lg shadow-sm hover:shadow-md">
        <h3 class="font-semibold text-green-700 mb-2">Empresas Cadastradas</h3>
        <p class="text-sm text-gray-600">Visualizar e filtrar por CNPJ, nome ou box.</p>
      </div>

      <!-- Arquivos -->
      <div class="p-4 border rounded-lg shadow-sm hover:shadow-md">
        <h3 class="font-semibold text-green-700 mb-2">Arquivos</h3>
        <p class="text-sm text-gray-600 mb-4">Baixar os documentos enviados pelo administrador.</p>
        <ul id="listaArquivos" class="space-y-2 text-sm text-gray-700"></ul>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-green-700 text-white text-center p-4 mt-12">
    <p>¬© 2025 CEASA - Sistema de Empresas</p>
  </footer>

  <script>
    // üîë Configura√ß√£o do Supabase
    const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";
    const SUPABASE_KEY = "SEU_PUBLIC_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ‚ö° Aqui voc√™ deve recuperar o CNPJ ou ID do usu√°rio logado
    // Pode ser salvo no localStorage durante o login
    const cnpjOuId = localStorage.getItem("empresaCnpj") || "TESTE123"; 

    // Fun√ß√£o para listar arquivos
    async function listarArquivos() {
      const listaEl = document.getElementById("listaArquivos");
      listaEl.innerHTML = "<li class='text-gray-500'>Carregando...</li>";

      const { data, error } = await supabase
        .storage
        .from("arquivos")
        .list(`${cnpjOuId}/`, {
          limit: 100,
          offset: 0,
          sortBy: { column: "created_at", order: "desc" }
        });

      if (error) {
        listaEl.innerHTML = `<li class="text-red-600">‚ùå Erro ao carregar arquivos: ${error.message}</li>`;
        return;
      }

      if (!data || data.length === 0) {
        listaEl.innerHTML = "<li class='text-gray-500'>Nenhum arquivo dispon√≠vel</li>";
        return;
      }

      const arquivosComLinks = await Promise.all(
        data.map(async (file) => {
          const { data: signedUrlData } = await supabase
            .storage
            .from("arquivos")
            .createSignedUrl(`${cnpjOuId}/${file.name}`, 300); // 5 min de validade

          return {
            name: file.name,
            url: signedUrlData?.signedUrl
          };
        })
      );

      listaEl.innerHTML = arquivosComLinks.map(a => `
        <li>
          <a href="${a.url}" target="_blank" class="text-blue-600 hover:underline">
            üìÑ ${a.name}
          </a>
        </li>
      `).join("");
    }

    // Carregar ao abrir o dashboard
    listarArquivos();
  </script>
</body>
</html>
